<?php
session_start();
$SCRIPT = substr($_SERVER['PHP_SELF'],1,strlen($_SERVER['PHP_SELF'])-5);	// script associé à l'onglet qui a téléchargé cette page
require"Controleur/RequeteBD.php";

/* Fichiers à créer pour un développement d'un futur onglet Ex: batiment spéciaux, missions
 * Soit X le nom du nouvel onglet
 * X.php à la racine
 * ajouter X dans le tableau $T_onglet
 * Vue/X.css feuille de style en plus de commun.css
 * Vue/images/onglet_X.png image de l'onglet
 * Modele/classe_TX.php classe associée au tableau
 * Modele/classe_BD_X la BDD
 * */

$T_onglet = array(
//	onglet		=> classe associée
	'index'		=> 'Joueur',
	'usines'	=> 'TUsine',
	'mines'		=> 'TMine',
	'entrepots'	=> 'TEntrepot',
	'commerce'	=> 'TCommerce');

// sauvegarde de l'état dans la session
if (!isset($_SESSION['IDjoueur'])) $_SESSION['IDjoueur'] = 1; // valeur initalisée lorsque le joueur se connecte. 1->joueur Lambda
$_SESSION['onglet'] = isset($T_onglet[$SCRIPT]) ? $SCRIPT : null;
$_SESSION['ID'] = (int) $_GET['id']; // indique la ligne sélectionnée dans un onglet

if (isset($T_onglet[$SCRIPT]) && ($SCRIPT!='index')) {
	require'Modele/classe_'.$T_onglet[$SCRIPT].'.php';	// chargement de la classe de tableau associée à l'onglet
	require'Modele/classe_LigneTableau.php'; // chargement de la classe mère des lignes de tableau
	require'Modele/classe_'.substr($T_onglet[$SCRIPT],1,9).'.php';	// chargement de la classe de ligne associée à l'onglet (on retire le T du nom)
}
else {
	// gérer le sinon
}

// joueur
require'Modele/classe_Joueur.php';
$Joueur=new Joueur;
$CONNEXION_JOUEUR = $Joueur->Cadre_connexion();

// construction de la page
ob_start();
if (isset($T_onglet[$SCRIPT])) { // un des onglets appelle cette page
	if ($SCRIPT=='index') {
		$Joueur->Présentation();
		// traitement
	} else { // onglet de type table
		$classeTableau = $T_onglet[$SCRIPT];
		$Tableau = new $classeTableau;
		$Tableau->Afficher_tete();
		$Tableau->Afficher_corps($_SESSION['ID']);
		$Tableau->CréerFormulaireMAJ();
	}
} else { // aucun des onglets sélectionnés
	$CODE_ERREUR = (isset($_SESSION['erreur'])) ? (int) $_SESSION['erreur'] : 0;
	echo"<h1>Erreur {$CODE_ERREUR}: {$DICO[$CODE_ERREUR]}</h1>\n<p>S&eacute;lectionnez un des onglets en haut de cette page.</p>\n";
	unset($_SESSION['erreur']);
}
$SECTION = ob_get_contents();
ob_end_clean();
?>
<!doctype html>
<html lang="fr">
<head>
	<meta charset="UTF-8" />
	<link rel="shortcut icon" type="image/png" href="Vue/images/resources.ico">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quicksand:400,700">
	<link rel="stylesheet" href="Vue/commun.css" />
	<link rel="stylesheet" href="Vue/<?=$SCRIPT?>.css" />
	<link rel="stylesheet" href="Vue/table.css" />
	<title>Gestion de production pour le jeu Resources</title>
</head>

<body>

<header>
	<p><img src="Vue/images/logo.png" alt="logo officiel">Gestion de production pour le jeu <img src="Vue/images/logo2.png" alt="2e logo officiel"></p>
</header>

<main>

<div id="joueur">
<?=$CONNEXION_JOUEUR?>
<?php
//print_r($_SESSION);
?>
</div>

<nav>
	<ul>
<?php
	foreach($T_onglet as $onglet => $valeur)
		echo "\t\t<li><a ",($onglet == $SCRIPT) ? 'id="onglet_actif" ' : '',"href=\"{$onglet}.php\"><img src=\"Vue/images/onglet_{$onglet}.png\" alt=\"onglet {$onglet}\"></a></li>\n";
?>
	</ul>
</nav>

<section>
	<div id="vers_le_haut"><a href="#"><img src="Vue/images/fleche_haut.png" alt="Retourner en haut" /></a></div>
<?=$SECTION?>
</section>

</main>
<?php include'Vue/pied2page.html';?>
</body>

</html>
